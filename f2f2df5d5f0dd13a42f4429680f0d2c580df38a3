{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "6e764d09_0b5bf340",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 26,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2023-04-25T21:00:48Z",
      "side": 1,
      "message": "that still seems like the \"least worst\" option though?\n\ni don\u0027t think adding a new API makes any sense --- no-one will use it.\n\n(if you do want to go this route, the libc-coord list is probably the place to start? or persuade linux that maybe darwin shouldn\u0027t be the only kernel with posix_spawn...)",
      "revId": "f2f2df5d5f0dd13a42f4429680f0d2c580df38a3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9272df3b_fa147350",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 26,
      "author": {
        "id": 1067098
      },
      "writtenOn": "2023-04-25T21:38:21Z",
      "side": 1,
      "message": "With this patch the users who likely actually matter will use it, i.e. posix_spawn and (with a separate patch) Java. I don\u0027t think we need to do more than that (e.g. persuade apps to use it).\n\nThe idea behind making it a public API is that apps have the option of using it if they need to (e.g. they use stack tagging in their internal testing builds and have a custom process launcher). But if you think this is too far-fetched we can make it a platform-private API for now.\n\nIt may be worth considering bringing this up on libc-coord, but I guess it wouldn\u0027t be necessary if we add it as a platform-private API. Maybe we can start with a private API and in parallel I will see if I can find some time to start a thread on libc-coord.",
      "parentUuid": "6e764d09_0b5bf340",
      "revId": "f2f2df5d5f0dd13a42f4429680f0d2c580df38a3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6d351c8c_fff921ff",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 26,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2023-04-25T23:57:07Z",
      "side": 1,
      "message": "\u003e But if you think this is too far-fetched we can make it a platform-private API for now.\n\nyeah, there\u0027s that, but i\u0027m also assuming we end up needing to make vfork() \u003d\u003d fork() for MTE in the end anyway?\n\n\u003e Maybe we can start with a private API\n\nthat sounds like a better place to start. (he says, not really understanding how ART deals with stuff like this. but that\u0027s going to be a problem for them to solve no matter what we do, other than switching them to fork().)",
      "parentUuid": "9272df3b_fa147350",
      "revId": "f2f2df5d5f0dd13a42f4429680f0d2c580df38a3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d64a7a22_01b5b221",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 26,
      "author": {
        "id": 1067098
      },
      "writtenOn": "2023-04-26T00:46:19Z",
      "side": 1,
      "message": "\u003e yeah, there\u0027s that, but i\u0027m also assuming we end up needing to make vfork() \u003d\u003d fork() for MTE in the end anyway?\n\nNot necessarily. The plan would be to leave vfork() in place with its caveats, and recommend that developers move to another API if they need stack MTE to work correctly. If we don\u0027t expose vforkrun() as a public API, we can recommend moving to posix_spawn().",
      "parentUuid": "6d351c8c_fff921ff",
      "revId": "f2f2df5d5f0dd13a42f4429680f0d2c580df38a3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "99955fb3_c1e568ef",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 26,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2023-04-26T21:20:22Z",
      "side": 1,
      "message": "\u003e Not necessarily. The plan would be to leave vfork() in place with its caveats, and recommend that developers move to another API if they need stack MTE to work correctly.\n\nthat seems like a barrier to MTE use amongst developers though? vfork() is probably magic left behind by the ancients to most people (as it is at google).\n\n\u003e If we don\u0027t expose vforkrun() as a public API, we can recommend moving to posix_spawn().\n\ni\u0027ve no idea what (if anything) apps use vfork() for but every time i look, most of the platform uses do have a reason.\n\ni note that ndk_translation implements vfork() as fork() for app code (because it needs to do translation), so there\u0027s some precedent for \"this is fine\"...",
      "parentUuid": "d64a7a22_01b5b221",
      "revId": "f2f2df5d5f0dd13a42f4429680f0d2c580df38a3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f435a0f3_c5565791",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 26,
      "author": {
        "id": 1067098
      },
      "writtenOn": "2023-04-26T22:50:10Z",
      "side": 1,
      "message": "\u003e that seems like a barrier to MTE use amongst developers though? vfork() is probably magic left behind by the ancients to most people (as it is at google).\n\nThis would only apply to stack MTE. However, I remembered that at least as currently implemented, stack MTE in apps would generally require a custom system image because the zygote doesn\u0027t enable stack MTE and it can\u0027t be turned on at runtime (you can build an executable with stack MTE, but most app developers don\u0027t ship executables). So I don\u0027t think it would affect normal app developers. Which I guess is an argument for not introducing a new public API at this point, because it solves a problem that no app developers will currently face.\n\n\u003e i\u0027ve no idea what (if anything) apps use vfork() for but every time i look, most of the platform uses do have a reason.\n\nI guess the reason for Java is:\n- fork() is too slow\n- posix_spawn() is not flexible enough (don\u0027t know if this is actually true)\n\nI\u0027m not aware of other users.\n\n\u003e i note that ndk_translation implements vfork() as fork() for app code (because it needs to do translation), so there\u0027s some precedent for \"this is fine\"...\n\nThe calls to vfork() from Java and posix_spawn() are from platform code so they would be calling the real vfork(), right? It would mean making fork() \u003d\u003d vfork() with stack MTE would affect more things than in the ndk_translation case.\n\nSo the position would be \"we don\u0027t care about the performance difference of stack MTE images, and the behavioral differences of vfork() probably don\u0027t matter\". I\u0027m not super comfortable with that (I don\u0027t like to rely on \"probably\") but I guess I could live with it.\n\nIt would mean going back to something like aosp/2507976 then, which I now realize is incorrect because it isn\u0027t calling the pre/post-fork handlers. That CL would need to be changed to call the handlers (i.e. move the new asm code to the top of the function and have it tail call `fork`), and get rid of the hardcoded constants.\n\nIf/when we propose to allow app developers to use stack MTE in the future, I would be less comfortable with not introducing a new API for accessing the real vfork(), because we don\u0027t know whether app developers will need it.",
      "parentUuid": "99955fb3_c1e568ef",
      "revId": "f2f2df5d5f0dd13a42f4429680f0d2c580df38a3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "36df9b4e_92be5890",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 26,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2023-04-26T22:57:24Z",
      "side": 1,
      "message": "\u003e * fork() is too slow\n\u003e * posix_spawn() is not flexible enough (don\u0027t know if this is actually true)\n\nyeah, these are the two most common reasons i see for non-libcore use cases too. (the former being more common than the latter, because most people don\u0027t even know about posix_spawn(). but a quick code search turns up at least one user doing something you can\u0027t do with posix_spawn().)\n\n\u003e So the position would be \"we don\u0027t care about the performance difference of stack MTE images, and the behavioral differences of vfork() probably don\u0027t matter\". I\u0027m not super comfortable with that (I don\u0027t like to rely on \"probably\") but I guess I could live with it.\n\nyeah, i\u0027m fairly comfortable with the performance half, but the behavioral side is a lot more dodgy.\n\n\u003e It would mean going back to something like aosp/2507976 then, which I now realize is incorrect because it isn\u0027t calling the pre/post-fork handlers. \n\n(which is one of the _other_ reasons we see for vfork() --- deliberately avoiding calling the atfork handlers. simpleperf does this, for example, though that may only be on the host?)\n\n\u003e If/when we propose to allow app developers to use stack MTE in the future, I would be less comfortable with not introducing a new API for accessing the real vfork(), because we don\u0027t know whether app developers will need it.\n\nyeah, but that\u0027s a completely different conversation then. (we might even want to change the header so that you don\u0027t _get_ vfork() if you\u0027re building with MTE.)",
      "parentUuid": "f435a0f3_c5565791",
      "revId": "f2f2df5d5f0dd13a42f4429680f0d2c580df38a3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "670ff766_54285747",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1067098
      },
      "writtenOn": "2023-04-25T20:45:31Z",
      "side": 1,
      "message": "enh: Ping.",
      "revId": "f2f2df5d5f0dd13a42f4429680f0d2c580df38a3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "428e8f0e_91d926e5",
        "filename": "libc/include/android/vforkrun.h",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2023-04-25T21:00:48Z",
      "side": 1,
      "message": "(or did you not mean to put this here, and intended this to be in \u003cplatform/\u003e instead? at the moment the declaration is public but the definition is private.)",
      "revId": "f2f2df5d5f0dd13a42f4429680f0d2c580df38a3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f0982656_1683c951",
        "filename": "libc/include/android/vforkrun.h",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1067098
      },
      "writtenOn": "2023-04-25T21:38:21Z",
      "side": 1,
      "message": "For the definition I was waiting for it to become possible to add this to LIBC_V.",
      "parentUuid": "428e8f0e_91d926e5",
      "revId": "f2f2df5d5f0dd13a42f4429680f0d2c580df38a3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}