{
  "comments": [
    {
      "key": {
        "uuid": "04e04612_110eaca4",
        "filename": "tests/pthread_test.cpp",
        "patchSetId": 2
      },
      "lineNbr": 89,
      "author": {
        "id": 1043845
      },
      "writtenOn": "2014-12-12T05:49:29Z",
      "side": 1,
      "message": "Isn\u0027t the bug here that sysconf is reporting the wrong number of keys? Or perhaps that pthread_key_create isn\u0027t failing as early as it\u0027s supposed to? man page says pthread_key_create fails after PTHREAD_KEYS_MAX keys have already been created, which is the case here if I understand the bug correctly.",
      "range": {
        "startLine": 89,
        "startChar": 83,
        "endLine": 89,
        "endChar": 93
      },
      "revId": "a5389bd7e422cf7dde3c70d84193f836d6e2b5c4",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "44a87ea2_86a15034",
        "filename": "tests/pthread_test.cpp",
        "patchSetId": 2
      },
      "lineNbr": 89,
      "author": {
        "id": 1056364
      },
      "writtenOn": "2014-12-12T06:31:42Z",
      "side": 1,
      "message": "As far as I can see:\n1. sysconf(_SC_THREAD_KEYS_MAX) should return the system resource limit of maximum pthread_keys user can use. It should never change in the process lifetime. I think it means the low boundary more than the up boundary.\n2. for pthread_key_create, posix standard  said it shall fail EAGAIN if the system lacks necessary resource or system limit of THREAD_KEYS_MAX is exceeded.\n\nAfter doing test on glibc, I find sysconf(_SC_THREAD_KEYS_MAX) returns 1024 and user can create exactly 1024 pthread keys. Yes, that\u0027s the right behavior. \nBut our problem is some of our bionic source code is taking advantages of pthread_keys. For example, if you call gethostbyname, it will use one pthread key, I you don\u0027t call it, it will not use. So the real pthread keys that can be used by users is not a fix number.\n\nCurrently I have no good idea of how to handle this. Maybe just keep it as before. After all, almost all users will not complain about they can create more pthread keys than what system resource limit said.",
      "parentUuid": "04e04612_110eaca4",
      "range": {
        "startLine": 89,
        "startChar": 83,
        "endLine": 89,
        "endChar": 93
      },
      "revId": "a5389bd7e422cf7dde3c70d84193f836d6e2b5c4",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "247f0a23_2cccd372",
        "filename": "tests/pthread_test.cpp",
        "patchSetId": 2
      },
      "lineNbr": 89,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2014-12-12T18:33:37Z",
      "side": 1,
      "message": "yes, sysconf results do tend to be the \"minimum maximum\".\n\nwe do try to account for the keys bionic can use internally though, and we have been trying to use __attribute__((constructor)) to make things more predictable (though this isn\u0027t free).\n\ni wonder if we should rewrite ThreadLocalBuffer.h to use one key that points to a struct that contains a pointer for each buffer? it would mean that we\u0027d have to have a central registry of all the thread local buffers, but that doesn\u0027t necessarily seem like a bad thing either.\n\nthe keys used by the DNS code are a bionic addition not in upstream, but even when you sync with upstream i think we\u0027ll want to keep that (because in bionic the non-_r functions try to be as safe as possible). there\u0027s a good argument that we shouldn\u0027t do this with the DNS functions but since we historically (\u003c\u003d L!) didn\u0027t have the full set of _r functions i don\u0027t think we can break the non-_r functions for multi-threaded use any time soon.\n\n\n\nbut right here right now, how about we say something like \"sysconf_max * 2\" to make it clear that we\u0027re deliberately just trying to allocate too much. (+10 seems like it might actually mean something, especially since we have roughly 10 internal-use keys.)",
      "parentUuid": "44a87ea2_86a15034",
      "range": {
        "startLine": 89,
        "startChar": 83,
        "endLine": 89,
        "endChar": 93
      },
      "revId": "a5389bd7e422cf7dde3c70d84193f836d6e2b5c4",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    }
  ]
}