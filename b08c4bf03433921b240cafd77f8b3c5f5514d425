{
  "comments": [
    {
      "key": {
        "uuid": "ded6f021_6faf9291",
        "filename": "libc/bionic/malloc_tagged_pointers.h",
        "patchSetId": 6
      },
      "lineNbr": 92,
      "author": {
        "id": 1005967
      },
      "writtenOn": "2020-01-08T01:56:05Z",
      "side": 1,
      "message": "This might not work when pointer tagging is disabled in an application. We need to allow deallocating previously tagged allocations.",
      "revId": "b08c4bf03433921b240cafd77f8b3c5f5514d425",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "dfb9adb4_68e3d475",
        "filename": "libc/bionic/malloc_tagged_pointers.h",
        "patchSetId": 6
      },
      "lineNbr": 92,
      "author": {
        "id": 1453063
      },
      "writtenOn": "2020-01-09T00:56:09Z",
      "side": 1,
      "message": "This is in relation to feature compat in the zygote, right?\n\nCurrently:\n     v tag of free-d ptr  v\n     ---------------------+\n     | 0x00 | 0x3c | 0xff |\n     +------+------+------+\n0x00 |  OK  |  BAD |  BAD |  // global \"heap tag\" 0x00 (disabled)\n0x3c |  BAD |  OK  |  BAD |  // global \"heap tag\" 0x3c (enabled)\n     +------+------+------+\n\nAllowing a previously-tagged alloc when heap tag is zero:\n\n     v tag of free-d ptr  v\n     ---------------------+\n     | 0x00 | 0x3c | 0xff |\n     +------+------+------+\n0x00 |  OK  | *OK* |  BAD |  // global \"heap tag\" 0x00 (disabled)\n0x3c |  BAD |  OK  |  BAD |  // global \"heap tag\" 0x3c (enabled)\n     +------+------+------+\n\nDone (although if you can validate my assumptions here that would be great).",
      "parentUuid": "ded6f021_6faf9291",
      "revId": "b08c4bf03433921b240cafd77f8b3c5f5514d425",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "140dff90_580e64fd",
        "filename": "libc/bionic/malloc_tagged_pointers.h",
        "patchSetId": 6
      },
      "lineNbr": 92,
      "author": {
        "id": 1005967
      },
      "writtenOn": "2020-01-09T01:08:12Z",
      "side": 1,
      "message": "This look correct, thank you.\n\nNow we need a way to actually disable the tagging. Could be done in\nhttps://android-review.googlesource.com/c/platform/bionic/+/1197046",
      "parentUuid": "dfb9adb4_68e3d475",
      "revId": "b08c4bf03433921b240cafd77f8b3c5f5514d425",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "773c0507_d61da142",
        "filename": "libc/bionic/malloc_tagged_pointers.h",
        "patchSetId": 6
      },
      "lineNbr": 92,
      "author": {
        "id": 1453063
      },
      "writtenOn": "2020-01-09T01:23:52Z",
      "side": 1,
      "message": "I was thinking a private interface between libc and the zygote, as we can\u0027t disable memory tagging once we reach a multi-threaded context, as the tag is currently loaded unatomically. WDYT?\n\nAlso - do we want to enable this uncoditionally for now?",
      "parentUuid": "140dff90_580e64fd",
      "revId": "b08c4bf03433921b240cafd77f8b3c5f5514d425",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7595d303_0d6616ea",
        "filename": "libc/bionic/malloc_tagged_pointers.h",
        "patchSetId": 6
      },
      "lineNbr": 92,
      "author": {
        "id": 1067098
      },
      "writtenOn": "2020-01-09T01:30:54Z",
      "side": 1,
      "message": "The android_mallopt function is indeed a private (i.e. not exposed to NDK) interface. For MTE there are similar constraints around disabling tagging before becoming multi-threaded, see the comments that I added to my new enumerator.",
      "parentUuid": "773c0507_d61da142",
      "revId": "b08c4bf03433921b240cafd77f8b3c5f5514d425",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2ec44b81_120c501a",
        "filename": "libc/bionic/malloc_tagged_pointers.h",
        "patchSetId": 6
      },
      "lineNbr": 92,
      "author": {
        "id": 1453063
      },
      "writtenOn": "2020-01-09T01:39:53Z",
      "side": 1,
      "message": "I see, thanks. I also think that having the \"no turning back on when off\" requirement is reasonable for us. Shall we introduce another enum (M_HEAP_TAGGING_LEVEL_STATIC) that\u0027s the default and means that we do static heap tagging (this patchset)?",
      "parentUuid": "7595d303_0d6616ea",
      "revId": "b08c4bf03433921b240cafd77f8b3c5f5514d425",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ecf87349_cae78c91",
        "filename": "libc/bionic/malloc_tagged_pointers.h",
        "patchSetId": 6
      },
      "lineNbr": 92,
      "author": {
        "id": 1067098
      },
      "writtenOn": "2020-01-09T01:50:23Z",
      "side": 1,
      "message": "Yes, I think this should be done by adding another enumerator. Regarding the default, we\u0027ll need to be a little careful since we\u0027ll want ASYNC to be the default on MTE-compatible hardware and STATIC elsewhere.",
      "parentUuid": "2ec44b81_120c501a",
      "revId": "b08c4bf03433921b240cafd77f8b3c5f5514d425",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "73353b63_7b4da22f",
        "filename": "libc/bionic/malloc_tagged_pointers.h",
        "patchSetId": 6
      },
      "lineNbr": 92,
      "author": {
        "id": 1453063
      },
      "writtenOn": "2020-01-09T02:11:36Z",
      "side": 1,
      "message": "Yep. For MTE-compatible hardware, we can change the __libc_init_globals() behaviour in libc_init_common.cpp from this patchset to call SetHeapTaggingLevel() directly.\n\nWould you like me to add the enum to the other patchset? Disabling heap tagging is done via:\n\n    globals-\u003eheap_pointer_tag \u003d 0",
      "parentUuid": "ecf87349_cae78c91",
      "revId": "b08c4bf03433921b240cafd77f8b3c5f5514d425",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "1199e90c_1a9834d1",
        "filename": "libc/bionic/malloc_tagged_pointers.h",
        "patchSetId": 6
      },
      "lineNbr": 92,
      "author": {
        "id": 1067098
      },
      "writtenOn": "2020-01-09T02:55:59Z",
      "side": 1,
      "message": "It would probably be best to rebase this change on top of my change, and add the enum in your change. I think it should be possible to do that by going to my change, following the instructions under \"Download -\u003e Checkout\", rebasing your change on top of that and uploading it.",
      "parentUuid": "73353b63_7b4da22f",
      "revId": "b08c4bf03433921b240cafd77f8b3c5f5514d425",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ee1965ca_43d3783e",
        "filename": "libc/bionic/malloc_tagged_pointers.h",
        "patchSetId": 6
      },
      "lineNbr": 92,
      "author": {
        "id": 1453063
      },
      "writtenOn": "2020-01-09T04:04:03Z",
      "side": 1,
      "message": "Given that the MTE-related parts of the mallopt changes are blocked on:\n - the changes to scudo, and\n - switching bionic to use scudo by default\n\n...would it make sense to carve out the mallopt() changes and make them pointer-tagging focused, with the MTE additions to come later?",
      "parentUuid": "1199e90c_1a9834d1",
      "revId": "b08c4bf03433921b240cafd77f8b3c5f5514d425",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c4823098_d6ea7fb4",
        "filename": "libc/bionic/malloc_tagged_pointers.h",
        "patchSetId": 6
      },
      "lineNbr": 92,
      "author": {
        "id": 1067098
      },
      "writtenOn": "2020-01-09T19:20:37Z",
      "side": 1,
      "message": "Okay, I\u0027ve split my mallopt change into one change that just adds the mallopt and another that adds the scudo/MTE bits.",
      "parentUuid": "ee1965ca_43d3783e",
      "revId": "b08c4bf03433921b240cafd77f8b3c5f5514d425",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "314c41c4_a6032986",
        "filename": "libc/bionic/malloc_tagged_pointers.h",
        "patchSetId": 6
      },
      "lineNbr": 92,
      "author": {
        "id": 1453063
      },
      "writtenOn": "2020-01-09T23:47:40Z",
      "side": 1,
      "message": "Ack, thanks.",
      "parentUuid": "c4823098_d6ea7fb4",
      "revId": "b08c4bf03433921b240cafd77f8b3c5f5514d425",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    }
  ]
}