{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "3acc65cf_6b855b5e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1067098
      },
      "writtenOn": "2023-03-25T01:44:01Z",
      "side": 1,
      "message": "This fixes the `spawn.signal_stress` test with stack MTE, but we should evaluate the performance impact on `posix_spawn` first.",
      "revId": "b1e77b735558274db84c740d72790a6df9e29891",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "129fdbb8_b7a38d2f",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1067098
      },
      "writtenOn": "2023-03-25T04:11:57Z",
      "side": 1,
      "message": "I measured the performance impact of this change using `bionic-spawn-benchmarks` on the target `aosp_cf_arm64_only_phone_hwasan-userdebug` running on an Apple M1. Here are sample baseline results:\n```\n----------------------------------------------------------------------------------------\nBenchmark                                              Time             CPU   Iterations\n----------------------------------------------------------------------------------------\nBM_spawn_test/noop/real_time                       17827 us          804 us           51\nBM_spawn_test/noop_nostl/real_time                 18466 us         1268 us           40\nBM_spawn_test/noop_static/real_time                 8781 us          901 us           70\nBM_spawn_test/bench_cxa_atexit/real_time          301725 us         1393 us            2\nBM_spawn_test/bench_cxa_atexit_full/real_time     529955 us         1407 us            1\nBM_spawn_test/system_bin_true/real_time            24192 us          982 us           57\nBM_spawn_test/vendor_bin_true/real_time            28152 us          900 us           27\nBM_spawn_test/system_sh_true/real_time             20042 us          824 us           36\nBM_spawn_test/vendor_sh_true/real_time             21441 us          942 us           35\n```\nI took the average real time of 10 runs with/without the change. All benchmarks showed no statistically significant difference except for `BM_spawn_test/noop_static/real_time` for which the difference was as follows (units are Î¼s):\n```\n+-------------------------------------------------------------------------------------------------------------------------------------------+\n|x     x            x  x               x          x  x              x      x   x   ++ +      ++        +        +   +            +         +|\n|            |___________________________A________M__________________|              |__________________MA__________________|                |\n+-------------------------------------------------------------------------------------------------------------------------------------------+\n    N           Min           Max        Median           Avg        Stddev\nx  10       8293.14       8865.04       8656.44      8591.384     206.58861\n+  10       8898.46       9310.23       9045.76      9051.949     143.65351\nDifference at 95.0% confidence\n        460.565 +/- 167.178\n        5.36078% +/- 1.94588%\n        (Student\u0027s t, pooled s \u003d 177.926)\n```\nThis is showing a 0.5ms slowdown. So what these results tell us is that except for the most trivial programs, the performance overhead of not using vfork is unmeasurable compared to the overhead of launching the program in the first place.\n\nThis seems fine to me, especially given that this is a debugging feature. If it weren\u0027t for the potential compatibility risks, I would probably be in favor of making this change unconditionally.\n\nOnce I\u0027ve removed the code that is made dead by this change, I\u0027ll remove my CR-1.",
      "parentUuid": "3acc65cf_6b855b5e",
      "revId": "b1e77b735558274db84c740d72790a6df9e29891",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "73d7b918_81987861",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2023-03-27T18:51:21Z",
      "side": 1,
      "message": "\u003e So what these results tell us is that except for the most trivial programs, the performance overhead of not using vfork is unmeasurable compared to the overhead of launching the program in the first place.\n\nisn\u0027t the opposite likely to be true? vfork()\u0027s meant to not be particularly useful for trivial programs, but become more beneficial the more VMAs you have?",
      "parentUuid": "129fdbb8_b7a38d2f",
      "revId": "b1e77b735558274db84c740d72790a6df9e29891",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c9bc0a6f_690b1d83",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1067098
      },
      "writtenOn": "2023-03-27T19:27:15Z",
      "side": 1,
      "message": "When I say \"trivial programs\" I was talking about the child process (the point being that if even trivial programs take 10ms to run with `posix_spawn`, adding 0.5ms to that doesn\u0027t really matter, and anything that people might actually want to run will increase the denominator further into unmeasurable territory).\n\nAs you mention, the complexity of the parent process is certainly a factor as well -- in this case it would be `bionic-spawn-benchmarks`.\n\nI had perhaps over-optimistically assumed that `bionic-spawn-benchmarks` would try to set up something more realistic for its own VMAs (e.g. replaying an allocator trace from the zygote first), but I couldn\u0027t see any evidence of that. Let me see if I can make `bionic-spawn-benchmarks` do that, and then rerun the benchmarks.",
      "parentUuid": "73d7b918_81987861",
      "revId": "b1e77b735558274db84c740d72790a6df9e29891",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "43c8c7f7_a31130d2",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1067098
      },
      "writtenOn": "2023-03-29T00:36:13Z",
      "side": 1,
      "message": "I sent out https://android-review.googlesource.com/q/Ib0f3885717fa1fcfdb85f3dffbb3827e370ebdf3 which teaches `bionic-spawn-benchmarks` to replay an allocation trace before running the benchmarks. With that I reran with `--memory_replay\u003d/data/local/tmp/traces/systemui.zip` and it showed a regression of around 4-5ms on many of the benchmarks. For example, `BM_spawn_test/noop_static/real_time`:\n```\n+-------------------------------------------------------------------------------------------------------------------------------------------+\n|x   x x  xx x                                                                                             +          +   + ++  +++   +    +|\n|   |__MA__|                                                                                                         |________A_M_____|     |\n+-------------------------------------------------------------------------------------------------------------------------------------------+\n    N           Min           Max        Median           Avg        Stddev\nx  10       6376.87       6890.79       6642.82      6669.376     150.97675\n+  10       10891.2       12227.5       11769.4      11657.78     370.72966\nDifference at 95.0% confidence\n        4988.4 +/- 265.952\n        74.7957% +/- 3.98767%\n        (Student\u0027s t, pooled s \u003d 283.05)\n```\nSo the case for making this change for these debugging features is a bit weaker but still seems fairly strong IMHO.",
      "parentUuid": "c9bc0a6f_690b1d83",
      "revId": "b1e77b735558274db84c740d72790a6df9e29891",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "77c3f73e_63736f25",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2023-03-29T20:15:46Z",
      "side": 1,
      "message": "\u003e So the case for making this change for these debugging features is a bit weaker but still seems fairly strong IMHO.\n\n(see my comment on the bug about whether this was the right comparison, but...)\n\ni guess the real arguing at cross-purposes here was that -- although i agree that hwasan is a debugging feature -- isn\u0027t the goal still for mte to be a non-debug feature?",
      "parentUuid": "43c8c7f7_a31130d2",
      "revId": "b1e77b735558274db84c740d72790a6df9e29891",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}