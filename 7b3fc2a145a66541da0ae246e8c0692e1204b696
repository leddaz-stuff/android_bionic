{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "d4595ea2_cfd68edd",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 24,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2022-03-30T00:19:05Z",
      "side": 1,
      "message": "i don\u0027t think that\u0027s _quite_ true... we do exactly what POSIX says, namely:\n\n\u003e The \u003carpa/inet.h\u003e header shall define the in_port_t and in_addr_t types as described in \u003cnetinet/in.h\u003e.\n\nand \n\n\u003e The \u003cnetinet/in.h\u003e header shall define the following types:\n\u003e ...\n\u003e in_addr_t\n\u003e    Equivalent to the type uint32_t as described in \u003cinttypes.h\u003e.\n\nthat\u0027s why the first line of this header is already `#include \u003cnetinet/in.h\u003e` --- we do the easy implementation of \"as described in\".\n\nso i think you might have a different problem than you think you have here?\n\ni will note that our \u003cnetinet/in.h\u003e only *transitively* includes \u003cbits/in_addr.h\u003e. maybe a side-effect of the dance we have to do with the uapi \"linux/in.h\" header (documented somewhat in bionic/libc/include/netinet/in.h)?\n\ndoes adding #include \u003cbits/in_addr.h\u003e to \u003cnetinet/in.h\u003e instead of \u003carpa/inet.h\u003e fix your problem? that seems more obviously correct, even if in theory redundant (and unclear to me why this would cause your symptom).",
      "range": {
        "startLine": 23,
        "startChar": 0,
        "endLine": 24,
        "endChar": 43
      },
      "revId": "7b3fc2a145a66541da0ae246e8c0692e1204b696",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "33c132b5_b751ddad",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 24,
      "author": {
        "id": 1114194
      },
      "writtenOn": "2022-03-30T19:54:40Z",
      "side": 1,
      "message": "Let\u0027s see if we can reproduce this outside of the kernel\u0027s build system.\n\nStrange, I would have expected this to fail:\n\n```\n$ cat arpa.c                                                                                                                                           \n#include \u003carpa/inet.h\u003e\n$ clang arpa.c -c --target\u003daarch64-linux-android31 --sysroot\u003d/path/to/prebuilts/ndk/toolchains/llvm/prebuilt/linux-x86_64/sysroot\n```\nsince that\u0027s essentially what the kernel header tests are doing.\n\nAh, looks like I\u0027m missing this patch which hasn\u0027t quite landed in mainline, yet.\nhttps://git.kernel.org/pub/scm/linux/kernel/git/masahiroy/linux-kbuild.git/commit/?h\u003dkbuild\u0026id\u003df442ec0815ed57fcc633fe763815ca3c27e4cd0e\n\nCherry-picking that is important, but doesn\u0027t solve the issue. It looks like the precise command invoked (trimmed and paths manually expanded) is something like:\n\n```\n$ clang --target\u003daarch64-linux-android31 --sysroot\u003d/android0/kernel-common/prebuilts/ndk/toolchains/llvm/prebuilt/linux-x86_64/sysroot -I /android0/kernel-common/out/android-mainline/common/usr/include -x c /dev/null -include /android0/kernel-common/out/android-mainline/common/usr/include/linux/tipc_config.h\n```\n\nFor in_addr_t\u0027s use in arpa/inet.h, the transitive include trail to the definition I would have expected is:\n\ntipc_config.h (kernel) (use of in_addr_t)\narpa/inet.h (bionic)\nnetinet/in.h (bionic)\nlinux/in.h (bionic)\nbits/in_addr.h (bionic) (definition of in_addr_t)\n\nRunning the above with `-M` to print the include trail, I see up to netinet/in.h, but linux/in.h is included from the kernel headers we\u0027re currently building, not bionic.  That linux/in.h does not include bits/in_addr.h.\n\nSo I guess I\u0027m curious why linux/in.h in the kernel [0] differs from bionic\u0027s linux/in.h [1]?\n\n[0] https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/include/uapi/linux/in.h\n[1] https://android.googlesource.com/platform/bionic/+/refs/heads/master/libc/kernel/uapi/linux/in.h#23",
      "parentUuid": "d4595ea2_cfd68edd",
      "range": {
        "startLine": 23,
        "startChar": 0,
        "endLine": 24,
        "endChar": 43
      },
      "revId": "7b3fc2a145a66541da0ae246e8c0692e1204b696",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "98cc1cf3_d45a5f30",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 24,
      "author": {
        "id": 1114194
      },
      "writtenOn": "2022-03-30T19:58:58Z",
      "side": 1,
      "message": "\u003e That linux/in.h does not include bits/in_addr.h.\n\n\u003e\u003e does adding #include \u003cbits/in_addr.h\u003e to \u003cnetinet/in.h\u003e instead of \u003carpa/inet.h\u003e fix your problem?\n\nLet me give that a shot.",
      "parentUuid": "33c132b5_b751ddad",
      "range": {
        "startLine": 23,
        "startChar": 0,
        "endLine": 24,
        "endChar": 43
      },
      "revId": "7b3fc2a145a66541da0ae246e8c0692e1204b696",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e400a0e4_c4182b2c",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 24,
      "author": {
        "id": 1114194
      },
      "writtenOn": "2022-03-30T20:01:25Z",
      "side": 1,
      "message": "/android0/kernel-common/prebuilts/ndk/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/include/bits/in_addr.h:43:8: error: redefinition of \u0027in_addr\u0027\nstruct in_addr {\n       ^\n/android0/kernel-common/out/android-mainline/common/usr/include/linux/in.h:89:8: note: previous definition is here\nstruct in_addr {\n       ^",
      "parentUuid": "98cc1cf3_d45a5f30",
      "range": {
        "startLine": 23,
        "startChar": 0,
        "endLine": 24,
        "endChar": 43
      },
      "revId": "7b3fc2a145a66541da0ae246e8c0692e1204b696",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "400261f0_daf1d78e",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 24,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2022-03-30T20:03:46Z",
      "side": 1,
      "message": "\u003e So I guess I\u0027m curious why linux/in.h in the kernel [0] differs from bionic\u0027s linux/in.h [1]?\n\nbecause we have to rewrite it... any time you see a reference to \u003cbits/*.h\u003e in a \u003clinux/*.h\u003e header, that\u0027s our python script making sure we get a userspace struct rather than a kernel one. (sadly i think linux has always assumed that their stuff is used via copy \u0026 paste rather than via direct inclusion. i think we\u0027re the only libc that\u0027s ever tried to do the latter.)",
      "parentUuid": "98cc1cf3_d45a5f30",
      "range": {
        "startLine": 23,
        "startChar": 0,
        "endLine": 24,
        "endChar": 43
      },
      "revId": "7b3fc2a145a66541da0ae246e8c0692e1204b696",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "4b4daa85_78f252ca",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1114194
      },
      "writtenOn": "2022-03-29T21:17:34Z",
      "side": 1,
      "message": "I\u0027m not quite sure yet, but I suspect I might find a few more of these type of fixes.\n\nIt\u0027s a bit of an interesting bootstrapping problem, since I can fix the headers in source, but in the kernel, I\u0027m trying to use an actual NDK release.\n\nSo testing this on top of the kernel changes I\u0027m working on is a workflow I haven\u0027t yet gotten into the rhythm quite yet.\n\nLet me know if you want me to hold CC\u0027ing you on a bunch of little changes until they\u0027re all ready for review, or squash them all into one patch.",
      "revId": "7b3fc2a145a66541da0ae246e8c0692e1204b696",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c3027341_dda9ec43",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1114194
      },
      "writtenOn": "2022-03-29T21:23:49Z",
      "side": 1,
      "message": "Also, I think include/uapi/linux/tipc_config.h in the linux kernel is incorrectly including arpa/inet.h. It has a comment /* for ntohs */ but ntohs is defined in the kernel\u0027s include/linux/byteorder/generic.h which is already included already in include/uapi/linux/tipc_config.h.",
      "parentUuid": "4b4daa85_78f252ca",
      "revId": "7b3fc2a145a66541da0ae246e8c0692e1204b696",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ad858565_ac0bd83a",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1114194
      },
      "writtenOn": "2022-03-29T21:34:07Z",
      "side": 1,
      "message": "Sent: https://lore.kernel.org/lkml/20220329212946.2861648-1-ndesaulniers@google.com/",
      "parentUuid": "c3027341_dda9ec43",
      "revId": "7b3fc2a145a66541da0ae246e8c0692e1204b696",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}