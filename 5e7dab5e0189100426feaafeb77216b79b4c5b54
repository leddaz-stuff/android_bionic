{
  "comments": [
    {
      "key": {
        "uuid": "48d9ad3d_ae2407b7",
        "filename": "libc/Android.mk",
        "patchSetId": 6
      },
      "lineNbr": 609,
      "author": {
        "id": 1013433
      },
      "writtenOn": "2016-04-27T18:53:24Z",
      "side": 1,
      "message": "@Christopher Ferris can you elaborate why this is ok?",
      "revId": "5e7dab5e0189100426feaafeb77216b79b4c5b54",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "48d9ad3d_2e2c773a",
        "filename": "libc/Android.mk",
        "patchSetId": 6
      },
      "lineNbr": 609,
      "author": {
        "id": 1019050
      },
      "writtenOn": "2016-04-27T19:29:39Z",
      "side": 1,
      "message": "The entirety of jemalloc is included in libc. It\u0027s only in a separate place because it is an external project. In fact, we could have moved this piece into external/jemalloc or created a small static library that only had this extra thing added but it\u0027s probably not worth the effort.\n\nIn the case below, you are taking part of the functionality of another library. The only real external library that is in libc is libjemalloc, and again that entire library is in libc.",
      "parentUuid": "48d9ad3d_ae2407b7",
      "revId": "5e7dab5e0189100426feaafeb77216b79b4c5b54",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "48d9ad3d_39791fed",
        "filename": "libc/Android.mk",
        "patchSetId": 6
      },
      "lineNbr": 609,
      "author": {
        "id": 1013433
      },
      "writtenOn": "2016-04-27T19:57:48Z",
      "side": 1,
      "message": "We actually use everything in libpackageparser. I would really like to avoid a copy + paste approach.\n\nPerhaps building out the .o file separately for libpackageparser and adding it into the recipe for this, this way theirs no possibility of a circular dependency.\n\nI was under the assumption that all built things implicitly get linked against Bionic libc and thus have a build dependency on bionic. Although, I looked at the recipe for jemalloc and I don\u0027t see it explicitly saying no libc. I guess I am unsure if Make would actually report a circular dependency there or not. \n\nI know ELF supports resolution of circular deps on symbols at link... At a glance, i didn\u0027t see any symbols used in jemalloc that are in bionic offhand. But I\u0027m still building so I only glanced at the source.",
      "parentUuid": "48d9ad3d_2e2c773a",
      "revId": "5e7dab5e0189100426feaafeb77216b79b4c5b54",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "08689501_461d3256",
        "filename": "libc/Android.mk",
        "patchSetId": 6
      },
      "lineNbr": 609,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2016-04-28T14:59:58Z",
      "side": 1,
      "message": "a *static* library has no dependencies in the ELF DT_NEEDED sense, just unresolved references. which, if you\u0027re linking into libc, will be resolved by it.",
      "parentUuid": "48d9ad3d_39791fed",
      "revId": "5e7dab5e0189100426feaafeb77216b79b4c5b54",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "48d9ad3d_8e03c362",
        "filename": "libc/Android.mk",
        "patchSetId": 6
      },
      "lineNbr": 612,
      "author": {
        "id": 1019050
      },
      "writtenOn": "2016-04-27T18:27:03Z",
      "side": 1,
      "message": "It\u0027s not acceptable to make libc depend on system core in this way.",
      "range": {
        "startLine": 612,
        "startChar": 25,
        "endLine": 612,
        "endChar": 66
      },
      "revId": "5e7dab5e0189100426feaafeb77216b79b4c5b54",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "48d9ad3d_ce694b17",
        "filename": "libc/bionic/grp_pwd.cpp",
        "patchSetId": 6
      },
      "lineNbr": 439,
      "author": {
        "id": 1019050
      },
      "writtenOn": "2016-04-27T18:27:03Z",
      "side": 1,
      "message": "I think this is a really bad idea, we shouldn\u0027t have libc essentially allowing undefined reference to a couple of functions which might be present. I think it would be much better to simply implement all of this code in a separate file.\n\nIn fact, this feels like a possible security bug.",
      "range": {
        "startLine": 437,
        "startChar": 0,
        "endLine": 439,
        "endChar": 38
      },
      "revId": "5e7dab5e0189100426feaafeb77216b79b4c5b54",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "48d9ad3d_8e25839d",
        "filename": "libc/bionic/grp_pwd.cpp",
        "patchSetId": 6
      },
      "lineNbr": 439,
      "author": {
        "id": 1013433
      },
      "writtenOn": "2016-04-27T18:53:24Z",
      "side": 1,
      "message": "That\u0027s a very valid point. I initially was more inclined to statically build libpackageparser and link it via LOCAL_WHOLE_STATIC_LIBRARIES similar to jemalloc.",
      "parentUuid": "48d9ad3d_ce694b17",
      "range": {
        "startLine": 437,
        "startChar": 0,
        "endLine": 439,
        "endChar": 38
      },
      "revId": "5e7dab5e0189100426feaafeb77216b79b4c5b54",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "48d9ad3d_2e5e37da",
        "filename": "libc/bionic/grp_pwd.cpp",
        "patchSetId": 6
      },
      "lineNbr": 439,
      "author": {
        "id": 1013433
      },
      "writtenOn": "2016-04-27T19:12:29Z",
      "side": 1,
      "message": "Although that would be a cyclic dependency, perhaps dlopen and call it that way...",
      "parentUuid": "48d9ad3d_8e25839d",
      "range": {
        "startLine": 437,
        "startChar": 0,
        "endLine": 439,
        "endChar": 38
      },
      "revId": "5e7dab5e0189100426feaafeb77216b79b4c5b54",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "48d9ad3d_0eeed3fc",
        "filename": "libc/bionic/grp_pwd.cpp",
        "patchSetId": 6
      },
      "lineNbr": 439,
      "author": {
        "id": 1019050
      },
      "writtenOn": "2016-04-27T19:29:39Z",
      "side": 1,
      "message": "Under no circumstances will that be acceptable. If you need this functionality in libc (and I don\u0027t think anyone is against doing something like this in libc) you really need to have it implemented here.\n\nIf at all possible, do not copy paste it either, or pull in the whole library. Please try and do the minimum to implement the needed functionality. I would still recommend putting all of this in a different file since it seems logically different than the functionality in this file.",
      "parentUuid": "48d9ad3d_2e5e37da",
      "range": {
        "startLine": 437,
        "startChar": 0,
        "endLine": 439,
        "endChar": 38
      },
      "revId": "5e7dab5e0189100426feaafeb77216b79b4c5b54",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "48d9ad3d_b9f7ef9b",
        "filename": "libc/bionic/grp_pwd.cpp",
        "patchSetId": 6
      },
      "lineNbr": 439,
      "author": {
        "id": 1032276
      },
      "writtenOn": "2016-04-27T19:51:17Z",
      "side": 1,
      "message": "Will do, will regroup on this (this would be the fifth in a series of prototypes to try to accomplish this).\n\nMy expectation is once implemented here (in grp_pwd.cpp or companion elsewhere), we may consider deprecating libpackagelistparser.",
      "parentUuid": "48d9ad3d_0eeed3fc",
      "range": {
        "startLine": 437,
        "startChar": 0,
        "endLine": 439,
        "endChar": 38
      },
      "revId": "5e7dab5e0189100426feaafeb77216b79b4c5b54",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "48d9ad3d_3904bf6d",
        "filename": "libc/bionic/grp_pwd.cpp",
        "patchSetId": 6
      },
      "lineNbr": 439,
      "author": {
        "id": 1013433
      },
      "writtenOn": "2016-04-27T19:57:48Z",
      "side": 1,
      "message": "The other lib is pretty small, we actual use it all.",
      "parentUuid": "48d9ad3d_0eeed3fc",
      "range": {
        "startLine": 437,
        "startChar": 0,
        "endLine": 439,
        "endChar": 38
      },
      "revId": "5e7dab5e0189100426feaafeb77216b79b4c5b54",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "48d9ad3d_99a4eb68",
        "filename": "libc/bionic/grp_pwd.cpp",
        "patchSetId": 6
      },
      "lineNbr": 439,
      "author": {
        "id": 1013433
      },
      "writtenOn": "2016-04-27T20:05:47Z",
      "side": 1,
      "message": "I thought about that as well, perhaps abusing some of the passwd fields to get all the information present in packages.lst file. Although, we should likely build a cache for things like sdcardd.\n\nTo actually deprecate we would have to map all of these fields into the other structs:\n\nstruct pkg_info \nchar *name;\nuid_t uid;\nbool debuggable;\nchar *data_dir;\nchar *seinfo;\ngid_list gids;\n\nPossible Map:\n\nstruct passwd          struct pkg_info   \nchar   *pw_name;       char *name\nchar   *pw_passwd;     \nuid_t   pw_uid;        uid_t uid\ngid_t   pw_gid;        \nchar   *pw_gecos;      bool debuggable\nchar   *pw_dir;        data_dir\nchar   *pw_shell;      char *seinfo\n\nstruct group {\nchar   *gr_name;       char *name\nchar   *gr_passwd;     \ngid_t   gr_gid;        uid_t uid\nchar  **gr_mem;        gid_list\n\n\nThis approach also has the obvious drawbacks..",
      "parentUuid": "48d9ad3d_b9f7ef9b",
      "range": {
        "startLine": 437,
        "startChar": 0,
        "endLine": 439,
        "endChar": 38
      },
      "revId": "5e7dab5e0189100426feaafeb77216b79b4c5b54",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "48d9ad3d_940e7223",
        "filename": "libc/bionic/grp_pwd.cpp",
        "patchSetId": 6
      },
      "lineNbr": 439,
      "author": {
        "id": 1032276
      },
      "writtenOn": "2016-04-28T16:36:15Z",
      "side": 1,
      "message": "- Probably best to _move_ libpackagelistparser into bionic, and bionicize it, opting to make it a private entity though.\n- cache should be lockless and have a per-thread structure; can not share the cache between threads :-(. A cache may simplify rather than complicate though.\n- gid_list is an issue since it is a series of names, not numbers, so we are then saddled with a series of getgrgid calls while inside getgrgid ... not a fan of recursion within libc (even though most are guaranteed to hit the traditional android_ids[] list). We probably can do this, restricting the supplemental gids we pick up to \u003cAID_APP. First entry of group list is the aid, followed by the gid_list.\n- pw-\u003egid \u003d uid\n- seinfo is not a shell, not touching that.\n- gecos field human readable name if !\u003d name. If we use debuggable that is a stretch too.\n\nCL series will likely look like:\n1) bionicize(tm) libpackagelistparser into bionic\n2) transition existing users of the library to private bionic interface\n3) deprecate libpackagelistparser in system/core\n4) grp_pwd.cpp use libpackagelistparser as KISS as possible.\n5) transition existing private users of libpackagelistparser to getpr*/getgr*\n6) enhance grp_pwd.cpp to use a cache, deal with detected hotspots, and _maybe_ add multiple gr_mem support to be pedantically correct. (assumes no one is using gid_list)\n\nNow is a good time to go on vacation ;-}",
      "parentUuid": "48d9ad3d_99a4eb68",
      "range": {
        "startLine": 437,
        "startChar": 0,
        "endLine": 439,
        "endChar": 38
      },
      "revId": "5e7dab5e0189100426feaafeb77216b79b4c5b54",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "08d5f532_4d48191e",
        "filename": "libc/bionic/grp_pwd.cpp",
        "patchSetId": 6
      },
      "lineNbr": 439,
      "author": {
        "id": 1013433
      },
      "writtenOn": "2016-04-28T20:15:53Z",
      "side": 1,
      "message": "\u003e - Probably best to _move_ libpackagelistparser into bionic, and\n \u003e bionicize it, opting to make it a private entity though.\n\nSo its ok to have an exported private api out of bionic?\n\n \u003e - gid_list is an issue since it is a series of names, not numbers,\n \u003e so we are then saddled with a series of getgrgid calls while inside\n \u003e getgrgid ... not a fan of recursion within libc (even though most\n \u003e are guaranteed to hit the traditional android_ids[] list). \n\nYep, it is not ideal.\n\nWe\n \u003e probably can do this, restricting the supplemental gids we pick up\n \u003e to \u003cAID_APP. First entry of group list is the aid, followed by the\n \u003e gid_list.\n \u003e - pw-\u003egid \u003d uid\n \u003e - seinfo is not a shell, not touching that.\n \u003e - gecos field human readable name if !\u003d name. If we use debuggable\n \u003e that is a stretch too.\n\nOh yeah I know this is a nasty stretch, I wasn\u0027t aware it was ok to export a private api out of bionic, seems strange to me.\n\n\u003csnip\u003e\n\n \u003e 5) transition existing private users of libpackagelistparser to\n \u003e getpr*/getgr*\n\nMost folks wont be able to switch, they would need access to seinfo and debuggable. sdcardd iirc is an example of one that could switch, but libselinux, run-as def cannot. \n\n\u003csnip\u003e\nNow is a good time to go on vacation ;-}\nWhat beach are we heading to?",
      "parentUuid": "48d9ad3d_940e7223",
      "range": {
        "startLine": 437,
        "startChar": 0,
        "endLine": 439,
        "endChar": 38
      },
      "revId": "5e7dab5e0189100426feaafeb77216b79b4c5b54",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    }
  ]
}